<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Gestione Tempo & Valore</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: #f5f6fa;
            padding: 20px;
            text-align: center;
        }
        h1, h2 { color: #333; }
        .container {
            max-width: 700px; /* Allargato leggermente per la tabella */
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .date-display {
            font-size: 1.2em;
            color: #7f8c8d;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .activity-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #ecf0f1;
            border-radius: 8px;
        }
        /* Stile specifico per la riga Svago per distinguerla */
        .svago-row {
            background: #fff3cd; /* Giallo chiaro */
            border: 1px solid #ffeeba;
        }
        .activity-label {
            font-weight: bold;
            flex: 1;
            text-align: left;
        }
        .time-inputs {
            flex: 2;
            text-align: right;
        }
        input[type="number"] {
            width: 60px;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #bdc3c7;
            text-align: center;
        }
        button {
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            margin-top: 10px;
        }
        .btn-calcola { background-color: #27ae60; color: white; width: 100%; }
        .btn-calcola:hover { background-color: #219150; }
        .btn-back { background-color: #95a5a6; color: white; margin-bottom: 20px; }
        
        #risultato {
            margin-top: 20px;
            padding: 15px;
            background-color: #dff9fb;
            border: 2px solid #badc58;
            border-radius: 8px;
            display: none;
        }
        #risultato h3 { margin: 0; color: #2ecc71; }
        #valoreNettoDisplay { font-size: 2em; display: block; margin: 10px 0; font-weight: bold; }

        /* Stile Storico */
        #storicoContainer { margin-top: 40px; text-align: left; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #34495e; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        .btn-delete { background-color: #e74c3c; padding: 5px 10px; font-size: 12px; color: white; border-radius: 4px; }
        
        /* Colori per il valore aggiunto */
        .positive { color: #27ae60; font-weight: bold; }
        .negative { color: #e74c3c; font-weight: bold; }
        .neutral { color: #7f8c8d; }
    </style>
</head>
<body>

    <button class="btn-back" onclick="history.back()">üîô Torna indietro</button>

    <div class="container">
        <h1>‚öñÔ∏è Bilancio Produttivit√† vs Svago</h1>
        <div class="date-display" id="dataOggi"></div>

        <div class="activity-row">
            <span class="activity-label">üìö Studio</span>
            <div class="time-inputs">
                <input type="number" id="studioH" placeholder="Ore" min="0"> h :
                <input type="number" id="studioM" placeholder="Min" min="0" max="59"> m
            </div>
        </div>

        <div class="activity-row">
            <span class="activity-label">üìñ Lettura</span>
            <div class="time-inputs">
                <input type="number" id="letturaH" placeholder="Ore" min="0"> h :
                <input type="number" id="letturaM" placeholder="Min" min="0" max="59"> m
            </div>
        </div>

        <div class="activity-row">
            <span class="activity-label">üèãÔ∏è Allenamento</span>
            <div class="time-inputs">
                <input type="number" id="allenamentoH" placeholder="Ore" min="0"> h :
                <input type="number" id="allenamentoM" placeholder="Min" min="0" max="59"> m
            </div>
        </div>

        <hr style="border: 0; border-top: 1px solid #ddd; margin: 15px 0;">

        <div class="activity-row svago-row">
            <span class="activity-label">üéÆ Svago / Gioco</span>
            <div class="time-inputs">
                <input type="number" id="svagoH" placeholder="Ore" min="0"> h :
                <input type="number" id="svagoM" placeholder="Min" min="0" max="59"> m
            </div>
        </div>

        <button class="btn-calcola" onclick="calcolaESalva()">üíæ Calcola Bilancio</button>

        <div id="risultato">
            <h3>üìä Valore Aggiunto Giornaliero:</h3>
            <span id="valoreNettoDisplay">0h 00m</span>
            <small id="dettaglioCalcolo"></small>
        </div>

        <div id="storicoContainer">
            <h3>üìÖ Storico Giorni Precedenti</h3>
            <table id="tabellaStorico">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Produttivit√†</th>
                        <th>Gioco</th>
                        <th>Valore Aggiunto</th>
                        <th>Azione</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
            <button onclick="pulisciStorico()" style="background-color: #c0392b; width: 100%; margin-top:10px; color: white;">üóëÔ∏è Cancella tutto lo storico</button>
        </div>
    </div>

    <script>
        // 1. Mostra la data di oggi all'avvio
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const oggi = new Date();
        document.getElementById('dataOggi').innerText = oggi.toLocaleDateString('it-IT', options);
        
        // Carica lo storico all'avvio
        caricaStorico();

        function convertiMinutiInStringa(minutiTotali) {
            const segno = minutiTotali < 0 ? "-" : "+";
            const absMinuti = Math.abs(minutiTotali);
            const ore = Math.floor(absMinuti / 60);
            const minuti = absMinuti % 60;
            const minFormat = minuti < 10 ? '0' + minuti : minuti;
            return `${segno}${ore}h ${minFormat}m`;
        }
        
        // Funzione semplice senza segno per i totali assoluti
        function formattaOrario(minutiTotali) {
            const ore = Math.floor(minutiTotali / 60);
            const minuti = minutiTotali % 60;
            const minFormat = minuti < 10 ? '0' + minuti : minuti;
            return `${ore}h ${minFormat}m`;
        }

        function calcolaESalva() {
            // Recupera valori Produttivit√†
            const sH = parseInt(document.getElementById('studioH').value) || 0;
            const sM = parseInt(document.getElementById('studioM').value) || 0;
            const lH = parseInt(document.getElementById('letturaH').value) || 0;
            const lM = parseInt(document.getElementById('letturaM').value) || 0;
            const aH = parseInt(document.getElementById('allenamentoH').value) || 0;
            const aM = parseInt(document.getElementById('allenamentoM').value) || 0;

            // Recupera valori Svago
            const gH = parseInt(document.getElementById('svagoH').value) || 0;
            const gM = parseInt(document.getElementById('svagoM').value) || 0;

            // Calcoli in minuti
            const minutiProduttivi = (sH * 60 + sM) + (lH * 60 + lM) + (aH * 60 + aM);
            const minutiSvago = (gH * 60 + gM);
            const differenza = minutiProduttivi - minutiSvago;

            // Generazione Stringhe
            const strProduttivi = formattaOrario(minutiProduttivi);
            const strSvago = formattaOrario(minutiSvago);
            const strDifferenza = convertiMinutiInStringa(differenza);

            // Mostra risultato a video
            const display = document.getElementById('valoreNettoDisplay');
            const dettaglio = document.getElementById('dettaglioCalcolo');
            
            display.innerText = strDifferenza;
            
            // Colore dinamico del risultato
            if(differenza > 0) display.style.color = "#27ae60"; // Verde
            else if(differenza < 0) display.style.color = "#e74c3c"; // Rosso
            else display.style.color = "#333";

            dettaglio.innerText = `(Produttivit√†: ${strProduttivi} - Gioco: ${strSvago})`;
            document.getElementById('risultato').style.display = 'block';

            // Salvataggio nel Local Storage
            salvaNelDatabase(strProduttivi, strSvago, strDifferenza, differenza);
        }

        function salvaNelDatabase(strProd, strSvago, strDiff, rawDiff) {
            const dataCorrente = new Date().toLocaleDateString('it-IT');
            let storico = JSON.parse(localStorage.getItem('diarioSvago')) || [];

            // Oggetto da salvare
            const nuovoRecord = {
                data: dataCorrente,
                tempoProduttivo: strProd,
                tempoSvago: strSvago,
                differenza: strDiff,
                rawValore: rawDiff // Utile per colorare la tabella
            };

            const indiceOggi = storico.findIndex(item => item.data === dataCorrente);

            if (indiceOggi !== -1) {
                storico[indiceOggi] = nuovoRecord; // Aggiorna oggi
            } else {
                storico.push(nuovoRecord); // Nuovo giorno
            }

            localStorage.setItem('diarioSvago', JSON.stringify(storico));
            caricaStorico(); 
        }

        function caricaStorico() {
            const storico = JSON.parse(localStorage.getItem('diarioSvago')) || [];
            const tbody = document.querySelector('#tabellaStorico tbody');
            tbody.innerHTML = ''; 

            storico.reverse().forEach((record, index) => {
                const tr = document.createElement('tr');
                
                // Compatibilit√† con vecchi dati (se non c'era la struttura nuova)
                const prod = record.tempoProduttivo || record.tempo || "0h 00m";
                const svago = record.tempoSvago || "0h 00m";
                let diff = record.differenza;
                let classeColore = "neutral";

                // Se √® un vecchio dato senza differenza calcolata, usiamo il produttivo come diff positiva
                if (!diff) {
                    diff = "+" + prod; 
                    classeColore = "positive";
                } else {
                    // Determina colore in base al valore raw o stringa
                    if (diff.includes("-")) classeColore = "negative";
                    else if (diff.includes("+") && diff !== "+0h 00m") classeColore = "positive";
                }

                tr.innerHTML = `
                    <td>${record.data}</td>
                    <td>${prod}</td>
                    <td>${svago}</td>
                    <td class="${classeColore}">${diff}</td>
                    <td><button class="btn-delete" onclick="eliminaRiga(${index})">‚ùå</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function eliminaRiga(index) {
            let storico = JSON.parse(localStorage.getItem('diarioSvago')) || [];
            const realIndex = storico.length - 1 - index;
            storico.splice(realIndex, 1);
            localStorage.setItem('diarioSvago', JSON.stringify(storico));
            caricaStorico();
        }

        function pulisciStorico() {
            if(confirm("Sei sicuro di voler cancellare tutto lo storico?")) {
                localStorage.removeItem('diarioSvago');
                caricaStorico();
            }
        }
    </script>
</body>
</html>
